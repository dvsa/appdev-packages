name: Publish to NPM

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run the workflow without publishing to npm'
        required: false
        type: boolean
      package:
        description: 'The package to publish'
        required: true
        type: choice
        options:
          - 'common'
          - 'feature-flags'
          - 'service-bundler'
          - 'aws-utils'
  push:
    branches:
      - main

jobs:
  orchestrator:
    name: Orchestrator
    runs-on: ubuntu-latest
    outputs:
      publish-common: ${{ steps.changed-common.outputs.any_changed == 'true' || null }}
      publish-feature-flags: ${{ steps.changed-feat-flags.outputs.any_changed == 'true' || null }}
      publish-service-bundler: ${{ steps.changed-service-bundler.outputs.any_changed == 'true' || null }}
      publish-aws-utils: ${{ steps.changed-aws-utils.outputs.any_changed == 'true' || null }}
    steps:
      - name: ðŸ“¨ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for `/packages/common` changes
        uses: tj-actions/changed-files@v44
        id: changed-common
        with:
          files: |
            packages/common/**

      - name: Check for `/packages/feature-flags` changes
        uses: tj-actions/changed-files@v44
        id: changed-feat-flags
        with:
          files: |
            packages/feature-flags/**    

      - name: Check for `/packages/service-bundler` changes
        uses: tj-actions/changed-files@v44
        id: changed-service-bundler
        with:
          files: |
            packages/service-bundler/**

      - name: Check for `/packages/aws-utils` changes
        uses: tj-actions/changed-files@v44
        id: changed-aws-utils
        with:
          files: |
            packages/aws-utils/**        

  publish-common:
    needs: orchestrator
    runs-on: ubuntu-latest
    if: ${{ needs.orchestrator.outputs.publish-common || github.event_name == 'workflow_dispatch' && inputs.package == 'common'}}
    steps:
      - name: ðŸ“¨ Checkout
        uses: actions/checkout@v4

      - name: Publish package "packages/common" ${{ inputs.dry-run && 'in' || 'not in' }} dry run mode
        uses: ./.github/actions/publish-package
        with:
          dry-run: ${{ inputs.dry-run && 'true' || 'false' }}
          package-path: 'packages/common'
          token: ${{ secrets.NPM_AUTH_TOKEN }}

  publish-feature-flags:
    needs: orchestrator
    runs-on: ubuntu-latest
    if: ${{ needs.orchestrator.outputs.publish-feature-flags || github.event_name == 'workflow_dispatch' && inputs.package == 'feature-flags' }}
    steps:
      - name: ðŸ“¨ Checkout
        uses: actions/checkout@v4

      - name: Publish package "packages/feature-flags" ${{ inputs.dry-run && 'in' || 'not in' }} dry run mode
        uses: ./.github/actions/publish-package
        with:
          dry-run: ${{ inputs.dry-run && 'true' || 'false' }}
          package-path: 'packages/feature-flags'
          token: ${{ secrets.NPM_AUTH_TOKEN }}

  publish-service-bundler:
    needs: orchestrator
    runs-on: ubuntu-latest
    if: ${{ needs.orchestrator.outputs.publish-service-bundler || github.event_name == 'workflow_dispatch' && inputs.package == 'service-bundler' }}
    steps:
      - name: ðŸ“¨ Checkout
        uses: actions/checkout@v4

      - name: Publish package "packages/service-bundler" ${{ inputs.dry-run && 'in' || 'not in' }} dry run mode
        uses: ./.github/actions/publish-package
        with:
          dry-run: ${{ inputs.dry-run && 'true' || 'false' }}
          package-path: 'packages/service-bundler'
          token: ${{ secrets.NPM_AUTH_TOKEN }}

  publish-aws-utils:
    needs: orchestrator
    runs-on: ubuntu-latest
    if: ${{ needs.orchestrator.outputs.publish-aws-utils || github.event_name == 'workflow_dispatch' && inputs.package == 'aws-utils' }}
    steps:
      - name: ðŸ“¨ Checkout
        uses: actions/checkout@v4

      - name: Publish package "packages/aws-utils" ${{ inputs.dry-run && 'in' || 'not in' }} dry run mode
        uses: ./.github/actions/publish-package
        with:
          dry-run: ${{ inputs.dry-run && 'true' || 'false' }}
          package-path: 'packages/aws-utils'
          token: ${{ secrets.NPM_AUTH_TOKEN }}
