name: Publish to NPM

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run the workflow without publishing to npm'
        required: false
        type: boolean
      package:
        description: 'The package to publish'
        required: true
        type: choice
        options:
          - 'common'
          - 'feature-flags'
  push:
    branches:
      - main

jobs:
  orchestrator:
    name: Orchestrator
    runs-on: ubuntu-latest
    outputs:
      publish-common: ${{ steps.changed-common.outputs.any_changed == 'true' || null }}
      publish-feature-flags: ${{ steps.changed-feat-flags.outputs.any_changed == 'true' || null }}
    steps:
      - name: ðŸ“¨ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for `/packages/common` changes
        uses: tj-actions/changed-files@v44
        id: changed-common
        with:
          files: |
            packages/common/**

      - name: Check for `/packages/feature-flags` changes
        uses: tj-actions/changed-files@v44
        id: changed-feat-flags
        with:
          files: |
            packages/feature-flags/**      

  publish-common:
    needs: orchestrator
    runs-on: ubuntu-latest
    if: ${{ needs.orchestrator.outputs.publish-common || github.event_name == 'workflow_dispatch' && inputs.package == 'common'}}
    steps:
      - name: ðŸ“¨ Checkout
        uses: actions/checkout@v4

      - name: Publish Package
        uses: ./.github/actions/publish-package
        with:
          dry-run: ${{ inputs.dry-run }}
          package-path: 'packages/common'

  publish-feature-flags:
    needs: orchestrator
    runs-on: ubuntu-latest
    if: ${{ needs.orchestrator.outputs.publish-feature-flags || github.event_name == 'workflow_dispatch' && inputs.package == 'feature-flags' }}
    steps:
      - name: ðŸ“¨ Checkout
        uses: actions/checkout@v4

      - name: Publish Package
        uses: ./.github/actions/publish-package
        with:
          dry-run: ${{ inputs.dry-run }}
          package-path: 'packages/feature-flags'
